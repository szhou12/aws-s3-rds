<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S3 File Manager</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        table { border-collapse: collapse; width: 70%; margin-top: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.6em 1em; }
        th { background: #f0f0f0; }
        .msg { padding: 0.5em 1em; margin-bottom: 1em; background: #e0ffe0; color: #008000; border: 1px solid #b2ffb2;}
        .error { background: #ffe0e0; color: #b20000; border: 1px solid #ffb2b2;}
        .btn { padding: 0.2em 0.8em; }
    </style>
</head>
<body>
    <h2>S3 File Manager</h2>

    <!-- Upload Form -->
    <form id="upload-form" method="POST" action="/upload" enctype="multipart/form-data">
        <input type="file" name="file" required>
        <button type="submit" class="btn">Upload</button>
    </form>

    <!-- Flash message (populated by Flask) -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="msg">
                {% for message in messages %}
                    {{ message }}<br>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Table of Files -->
    <table id="file-table">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Size (KB)</th>
                <th>Last Modified</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows populated by JS -->
        </tbody>
    </table>

<script>
    // Fetch file list and update the table
    function refreshFileList() {
        fetch('/list-files')
            .then(resp => resp.json())
            .then(data => {
                const tbody = document.querySelector('#file-table tbody');
                tbody.innerHTML = '';
                if (data.success && data.files.length) {
                    data.files.forEach(file => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${file.key}</td>
                            <td style="text-align:right">${file.size}</td>
                            <td>${file.last_modified.replace('T', ' ').slice(0,19)}</td>
                            <td>
                                <a class="btn" href="/download/${encodeURIComponent(file.key)}">Download</a>
                                <a class="btn" href="/delete/${encodeURIComponent(file.key)}" onclick="return confirm('Delete ${file.key}?');">Delete</a>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="4" style="text-align:center;">No files found.</td>`;
                    tbody.appendChild(tr);
                }
            });
    }

    // Refresh list on page load
    refreshFileList();

    // Refresh list after upload (using form submit, reloads page)
    document.getElementById('upload-form').addEventListener('submit', function(e){
        setTimeout(refreshFileList, 1000); // After upload, give backend a moment to finish, then refresh
    });
</script>
</body>
</html>
