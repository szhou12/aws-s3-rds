<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>S3 File Manager</title>
    <style>
        body { font-family: sans-serif; margin: 2em; }
        table { border-collapse: collapse; width: 70%; margin-top: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.6em 1em; }
        th { background: #f0f0f0; }
        .msg { padding: 0.5em 1em; margin-bottom: 1em; background: #e0ffe0; color: #008000; border: 1px solid #b2ffb2;}
        .error { background: #ffe0e0; color: #b20000; border: 1px solid #ffb2b2;}
        .btn { padding: 0.2em 0.8em; }
        .form-group {
            margin-bottom: 1em;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3em;
            font-weight: bold;
        }

        .form-group input[type="text"], 
        .form-group select {
            width: 100%;
            max-width: 400px;
            padding: 0.5em;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .form-group input[type="file"] {
            padding: 0.3em;
        }
    </style>
</head>
<body>
    <h2>S3 File Manager</h2>

    <!-- Current Upload Form -->
    <form id="upload-form" method="POST" action="/upload" enctype="multipart/form-data">
        <!-- File Selection -->
        <div class="form-group">
            <label for="file">Select File:</label>
            <input type="file" name="file" id="file" required>
        </div>
        
        <!-- Custom Filename -->
        <div class="form-group">
            <label for="filename">Filename:</label>
            <input type="text" name="filename" id="filename" placeholder="Enter filename" required>
        </div>
        
        <!-- Author(s) -->
        <div class="form-group">
            <label for="authors">Author(s):</label>
            <input type="text" name="authors" id="authors" placeholder="e.g., John Doe, Jane Smith" required>
        </div>
        
        <!-- Language Dropdown -->
        <div class="form-group">
            <label for="language">Language:</label>
            <select name="language" id="language" required>
                <option value="">-- Select Language --</option>
                <option value="en">English</option>
                <option value="zh">中文</option>
            </select>
        </div>
        
        <button type="submit" class="btn">Upload</button>
    </form>

    <!-- Message display (for FastAPI query parameters) -->
    {% if message %}
        <div class="msg {% if message_type == 'error' %}error{% endif %}">
            {{ message }}
        </div>
    {% endif %}

    <!-- Table of Files -->
    <table id="file-table">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Size (KB)</th>
                <th>Last Modified</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows populated by JS -->
        </tbody>
    </table>

<script>
    // Extract source filename from S3 key (removes UUID__ prefix)
    function getSourceFilename(s3Key) {
        if (s3Key.includes('/')) {
            return s3Key.split('/', 2)[1]; // Get filename after UUID/
        }
        return s3Key; // Fallback for legacy keys
    }

    // Fetch file list and update the table
    function refreshFileList() {
        fetch('/list-files')
            .then(resp => resp.json())
            .then(data => {
                const tbody = document.querySelector('#file-table tbody');
                tbody.innerHTML = '';
                if (data.success && data.files.length) {
                    data.files.forEach(file => {
                        const tr = document.createElement('tr');
                        const sourceFilename = getSourceFilename(file.key);
                        
                        // Store S3 key in data attribute, display source filename
                        tr.setAttribute('data-s3-key', file.key);
                        tr.innerHTML = `
                            <td title="S3 Key: ${file.key}">${sourceFilename}</td>
                            <td style="text-align:right">${file.size}</td>
                            <td>${file.last_modified.replace('T', ' ').slice(0,19)}</td>
                            <td>
                                <a class="btn" href="/download/${encodeURIComponent(file.key)}">Download</a>
                                <a class="btn" href="/delete/${encodeURIComponent(file.key)}" onclick="return confirm('Delete ${sourceFilename}?');">Delete</a>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="4" style="text-align:center;">No files found.</td>`;
                    tbody.appendChild(tr);
                }
            });
    }

    // Refresh list on page load
    refreshFileList();

    // Refresh list after upload (using form submit, reloads page)
    document.getElementById('upload-form').addEventListener('submit', function(e){
        setTimeout(refreshFileList, 1000); // After upload, give backend a moment to finish, then refresh
    });
</script>
</body>
</html>
